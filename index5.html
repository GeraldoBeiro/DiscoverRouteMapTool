<html>
  <head>
    <meta charset="utf-8" />
    <script>
      class BancoDeDados {
        static #endPoint = "https://kvdb.io/";
        #rashBucket;
        #keyInTheRashBucketName;
        #email = email;
        #defaultObject;
        constructor(rashBucket, keyInTheRashBucketName, email, defaultObject) {
          this.#rashBucket = rashBucket;
          this.#keyInTheRashBucketName = keyInTheRashBucketName;
          this.#email = email;
          this.#defaultObject = defaultObject;
        }

        async init() {
           this.dados = this.#defaultObject;
        }

        static async getNewRashBucket(email) {
          let response = await fetch(this.#endPoint, {
            method: "post",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email: email }),
          });
          let newKey = response.text();
          return newKey;
        }

        async #getDados() {
          let response = await fetch(
            BancoDeDados.#endPoint +
              this.#rashBucket +
              "/" +
              this.#keyInTheRashBucketName
          );
          return response.json();
        }

        get dados() {
          return this.#getDados();
        }

        set dados(valor) {
          return this.#setDados(valor);
        }

        async updatePropriedade(propriedade, valor) {
          var dados = await this.dados;
          dados[propriedade] = valor;
          return (this.dados = dados);
        }

        async resetDados() {
          return (this.dados = this.#defaultObject);
        }

        async #setDados(objeto, onsuccess) {
          try {
            let response =  fetch(
              BancoDeDados.#endPoint +
                this.#rashBucket +
                "/" +
                this.#keyInTheRashBucketName,
              {
                method: "post",
                body: JSON.stringify(objeto),
                headers: { "Content-Type": "application/json" },
              }
            );
            /* if (response.status != 200) {
              return  response.text();
            } else if (response.status == 200 && onsuccess) {
              onsuccess();
            }*/
            return response;
          } catch (e) {
            console.log("rolou um erro");
            throw e;
          }
        }
      }
    </script>
  </head>

  <body>
    <div id="divStatus" style="font-size: 26px; color: red"></div>

    <script>
      var keyInTheHashBcuket = "listaComLocalizacoes";
      let email = "angelocarlotto@gmail.com";
      let bancoDeDados = null;
      var secretKVDB = null;
      var queryString = window.location.search;
      if (queryString) {
        var params = new URLSearchParams(queryString);
        if (params.has("id")) {
          secretKVDB = params.get("id");
        }
      }
      divStatus.innerHTML = "carregando dados da API";
      //caso a hashBucket nao tenha sido informado no URL
      if (!secretKVDB) {
        divStatus.innerHTML += "<br><br>criando nova chave da API";
        BancoDeDados.getNewRashBucket(email).then(async (newHashBucket) => {
          divStatus.innerHTML +=
            "<br><br>nova chave obtida. inicializando dados.";

          bancoDeDados = new BancoDeDados(
            newHashBucket,
            keyInTheHashBcuket,
            email,
            {
              marcadores: [],
              circulos: [],
              linhas: [],
              lastBound: null,
            }
          );
          await bancoDeDados.init();
          divStatus.innerHTML +=
            "<br><br>dados atualizado. pode utilizar a aplicação =]";
          var newUrl = window.location.href + "?id=" + newHashBucket;
          window.history.pushState({ path: newUrl }, "", newUrl);
          /* novo codigo */
        });
      } else {
        try {
          divStatus.innerHTML +=
            "<br><br>hash infromado, inicializando banco de dados";
          bancoDeDados = new BancoDeDados(
            secretKVDB,
            keyInTheHashBcuket,
            email,
            {
              marcadores: [],
              circulos: [],
              linhas: [],
              lastBound: null,
            }
          );
          bancoDeDados.init().then(() => {
            console.log(33);
            divStatus.innerHTML +=
              "<br><br>dados atualizado. pode utilizar a aplicação =]";
          });
        } catch (e) {
          divStatus.innerHTML += "<br><br>erro ao recuperar os dados";
        }

        /* novo codigo */
      }
    </script>
  </body>
</html>
